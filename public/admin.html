<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Chatbot Admin Panel</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
        }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .users-list, .history-list { 
            max-height: 300px; 
            overflow-y: auto; 
            border: 1px solid #ddd; 
            padding: 10px; 
            margin: 10px 0;
        }
        .user-item, .history-item { 
            padding: 8px; 
            border-bottom: 1px solid #eee; 
        }
        .user-item:hover { background: #f8f9fa; }
        button { 
            padding: 8px 16px; 
            margin: 5px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
        }
        .btn-kick { background: #dc3545; color: white; }
        .btn-broadcast { background: #007bff; color: white; }
        .btn-refresh { background: #28a745; color: white; }
        input, textarea { 
            width: 100%; 
            padding: 8px; 
            margin: 5px 0; 
            border: 1px solid #ddd; 
            border-radius: 4px;
        }
        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 10px; 
            margin: 10px 0;
        }
        .stat-item { 
            background: #e9ecef; 
            padding: 10px; 
            border-radius: 4px; 
            text-align: center;
        }
        .admin-section {
            border: 2px solid #28a745;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #f8fff9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🏥 Medical Chatbot Admin Panel</h1>
        
        <!-- Connection Status -->
        <div id="status" class="status disconnected">
            🔴 Disconnected
        </div>

        <!-- Connection Form -->
        <div id="connectionForm">
            <h3>Connect as Admin</h3>
            <input type="text" id="serverUrl" placeholder="Server URL" value="https://ai-chatbot-backend-ouvg.onrender.com">
            <input type="password" id="adminSecret" placeholder="Admin Secret" value="ghayth031957">
            <button onclick="connectAsAdmin()" class="btn-refresh">🔓 Connect as Admin</button>
        </div>

        <!-- Admin Controls -->
        <div id="adminControls" style="display: none;" class="admin-section">
            <h3>🔧 Admin Controls</h3>
            
            <!-- Server Stats -->
            <div class="stats" id="serverStats">
                <div class="stat-item">📊 Loading...</div>
            </div>

            <!-- Broadcast Message -->
            <div>
                <h4>📢 Broadcast Message</h4>
                <textarea id="broadcastMessage" placeholder="Enter message to broadcast to all users..." rows="3"></textarea>
                <button onclick="broadcastMessage()" class="btn-broadcast">📤 Broadcast to All Users</button>
            </div>

            <!-- Connected Users -->
            <div>
                <h4>👥 Connected Users (<span id="usersCount">0</span>)</h4>
                <div class="users-list" id="usersList">
                    <div>No users connected</div>
                </div>
                <button onclick="refreshUsers()" class="btn-refresh">🔄 Refresh Users</button>
            </div>

            <!-- Recent Chat History -->
            <div>
                <h4>💬 Recent Chat History</h4>
                <div class="history-list" id="chatHistory">
                    <div>No chat history</div>
                </div>
                <button onclick="refreshHistory()" class="btn-refresh">🔄 Refresh History</button>
            </div>

            <!-- Quick Actions -->
            <div>
                <h4>⚡ Quick Actions</h4>
                <button onclick="getStats()" class="btn-refresh">📊 Get Server Stats</button>
                <button onclick="getHistory()" class="btn-refresh">💬 Get Chat History</button>
            </div>
        </div>
    </div>

    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        let socket = null;
        let adminUpdateInterval = null;

        function connectAsAdmin() {
            const serverUrl = document.getElementById('serverUrl').value;
            const adminSecret = document.getElementById('adminSecret').value;

            // Disconnect existing connection
            if (socket) {
                socket.disconnect();
                if (adminUpdateInterval) {
                    clearInterval(adminUpdateInterval);
                }
            }

            // Connect with admin secret
            socket = io(serverUrl, {
                auth: {
                    secret: adminSecret
                }
            });

            // Connection events
            socket.on('connect', () => {
                updateStatus('🟢 Connected as Admin', 'connected');
                document.getElementById('adminControls').style.display = 'block';
                console.log('Connected as admin');
            });

            socket.on('disconnect', (reason) => {
                updateStatus('🔴 Disconnected: ' + reason, 'disconnected');
                document.getElementById('adminControls').style.display = 'none';
                if (adminUpdateInterval) {
                    clearInterval(adminUpdateInterval);
                }
            });

            socket.on('connect_error', (error) => {
                updateStatus('🔴 Connection Error: ' + error.message, 'disconnected');
                document.getElementById('adminControls').style.display = 'none';
            });

            // Admin-specific events
            socket.on('admin_welcome', (data) => {
                console.log('Admin welcome:', data);
                alert('✅ ' + data.message);
                updateUsersList(data.users);
                updateStats(data.stats);
            });

            socket.on('admin_users_update', (data) => {
                updateUsersList(data.users);
                updateStats(data.stats);
            });

            socket.on('admin_stats', (stats) => {
                updateStats(stats);
            });

            socket.on('admin_chat_history', (history) => {
                updateChatHistory(history);
            });

            socket.on('admin_action_result', (result) => {
                console.log('Admin action result:', result);
                if (result.success) {
                    alert('✅ ' + result.message);
                } else {
                    alert('❌ ' + result.message);
                }
                
                // Refresh data after actions
                if (result.action === 'kick_user' || result.action === 'block_user') {
                    setTimeout(() => {
                        socket.emit('admin_get_stats');
                    }, 1000);
                }
            });

            // Handle admin announcement feedback
            socket.on('admin_announcement', (data) => {
                console.log('Announcement sent:', data);
            });
        }

        function updateStatus(message, className) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${className}`;
        }

        function updateUsersList(users) {
            const usersList = document.getElementById('usersList');
            const usersCount = document.getElementById('usersCount');
            
            if (!users || users.length === 0) {
                usersList.innerHTML = '<div>No users connected</div>';
                usersCount.textContent = '0';
                return;
            }

            usersCount.textContent = users.length;
            usersList.innerHTML = users.map(user => `
                <div class="user-item">
                    <strong>Socket ID:</strong> ${user.socketId}<br>
                    <strong>IP:</strong> ${user.ip || 'Unknown'}<br>
                    <strong>Connected:</strong> ${user.connectionTime || 'Unknown'}<br>
                    <strong>User Agent:</strong> ${user.userAgent || 'Unknown'}<br>
                    <button onclick="kickUser('${user.socketId}')" class="btn-kick">🚫 Kick User</button>
                    <button onclick="blockUser('${user.socketId}')" class="btn-kick">⛔ Block User</button>
                </div>
            `).join('');
        }

        function updateStats(stats) {
            const statsElement = document.getElementById('serverStats');
            if (!stats) {
                statsElement.innerHTML = '<div class="stat-item">📊 No stats available</div>';
                return;
            }

            statsElement.innerHTML = `
                <div class="stat-item">
                    <strong>👥 Connected Users</strong><br>
                    ${stats.totalConnections || 0}
                </div>
                <div class="stat-item">
                    <strong>💬 Chat History</strong><br>
                    ${stats.chatHistorySize || 0} messages
                </div>
                <div class="stat-item">
                    <strong>⏰ Server Uptime</strong><br>
                    ${stats.serverUptime ? Math.floor(stats.serverUptime / 60) + 'm ' + Math.floor(stats.serverUptime % 60) + 's' : 'Unknown'}
                </div>
                <div class="stat-item">
                    <strong>📅 Last Update</strong><br>
                    ${stats.timestamp ? new Date(stats.timestamp).toLocaleTimeString() : 'Unknown'}
                </div>
            `;
        }

        function updateChatHistory(history) {
            const historyElement = document.getElementById('chatHistory');
            
            if (!history || history.length === 0) {
                historyElement.innerHTML = '<div>No chat history</div>';
                return;
            }

            // Show latest first
            const reversedHistory = history.slice().reverse();
            
            historyElement.innerHTML = reversedHistory.map(entry => `
                <div class="history-item">
                    <strong>[${entry.timestampReadable || new Date(entry.timestamp).toLocaleString()}]</strong><br>
                    <strong>Socket:</strong> ${entry.socketId}<br>
                    <strong>Type:</strong> ${entry.type || 'unknown'}<br>
                    <strong>Content:</strong> ${entry.content ? entry.content.substring(0, 100) + (entry.content.length > 100 ? '...' : '') : 'No content'}
                </div>
            `).join('');
        }

        // Admin actions
        function kickUser(socketId) {
            if (confirm(`Are you sure you want to kick user ${socketId}?`)) {
                socket.emit('admin_kick_user', { socketId });
            }
        }

        function blockUser(socketId) {
            if (confirm(`Are you sure you want to block user ${socketId}?`)) {
                socket.emit('admin_block_user', { socketId });
            }
        }

        function broadcastMessage() {
            const message = document.getElementById('broadcastMessage').value.trim();
            if (!message) {
                alert('Please enter a message to broadcast');
                return;
            }
            
            if (confirm('Are you sure you want to broadcast this message to all users?')) {
                socket.emit('admin_broadcast', { message });
                document.getElementById('broadcastMessage').value = '';
            }
        }

        function refreshUsers() {
            socket.emit('admin_get_stats');
        }

        function getStats() {
            socket.emit('admin_get_stats');
        }

        function getHistory() {
            socket.emit('admin_get_history');
        }

        function refreshHistory() {
            socket.emit('admin_get_history');
        }

        // Auto-connect if values are present
        window.onload = function() {
            const secret = document.getElementById('adminSecret').value;
            if (secret) {
                // Auto-connect after a short delay
                setTimeout(() => {
                    connectAsAdmin();
                }, 500);
            }
        };

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            if (socket) {
                socket.disconnect();
            }
            if (adminUpdateInterval) {
                clearInterval(adminUpdateInterval);
            }
        });
    </script>
</body>
</html>

