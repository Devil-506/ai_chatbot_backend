<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Chatbot Admin Panel</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
        }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .users-list, .history-list { 
            max-height: 300px; 
            overflow-y: auto; 
            border: 1px solid #ddd; 
            padding: 10px; 
            margin: 10px 0;
        }
        .user-item, .history-item { 
            padding: 8px; 
            border-bottom: 1px solid #eee; 
        }
        .user-item:hover { background: #f8f9fa; }
        button { 
            padding: 8px 16px; 
            margin: 5px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
        }
        .btn-kick { background: #dc3545; color: white; }
        .btn-broadcast { background: #007bff; color: white; }
        .btn-refresh { background: #28a745; color: white; }
        input, textarea { 
            width: 100%; 
            padding: 8px; 
            margin: 5px 0; 
            border: 1px solid #ddd; 
            border-radius: 4px;
        }
        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 10px; 
            margin: 10px 0;
        }
        .stat-item { 
            background: #e9ecef; 
            padding: 10px; 
            border-radius: 4px; 
            text-align: center;
        }
        .admin-section {
            border: 2px solid #28a745;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #f8fff9;
        }
        .debug-console {
            background: #1a1a1a;
            color: #00ff00;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 150px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ Medical Chatbot Admin Panel</h1>
        
        <!-- Connection Status -->
        <div id="status" class="status disconnected">
            ğŸ”´ Disconnected
        </div>

        <!-- Connection Form -->
        <div id="connectionForm">
            <h3>Connect as Admin</h3>
            <input type="text" id="serverUrl" placeholder="Server URL" value="https://ai-chatbot-backend-ouvg.onrender.com">
            <input type="password" id="adminSecret" placeholder="Admin Secret" value="iamtheserver2024">
            <button onclick="connectAsAdmin()" class="btn-refresh">ğŸ”“ Connect as Admin</button>
            
            <div style="margin-top: 10px; font-size: 12px; color: #666;">
                <strong>Auto-detected:</strong> 
                <span id="environmentInfo">Detecting environment...</span>
            </div>
        </div>

        <!-- Debug Console -->
        <div class="debug-console" id="debugConsole">
            <div>ğŸ”§ Debug Console - Ready</div>
        </div>

        <!-- Debug Controls -->
        <div style="background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 4px;">
            <h4>ğŸ”§ Debug Tools</h4>
            <button onclick="testAdminCommands()" class="btn-refresh">ğŸ§ª Test Admin Commands</button>
            <button onclick="showSocketInfo()" class="btn-refresh">ğŸ”Œ Show Socket Info</button>
            <button onclick="clearDebugConsole()" class="btn-refresh">ğŸ—‘ï¸ Clear Console</button>
        </div>

        <!-- Admin Controls -->
        <div id="adminControls" style="display: none;" class="admin-section">
            <h3>ğŸ”§ Admin Controls</h3>
            
            <!-- Server Stats -->
            <div class="stats" id="serverStats">
                <div class="stat-item">ğŸ“Š Loading...</div>
            </div>

            <!-- Broadcast Message -->
            <div>
                <h4>ğŸ“¢ Broadcast Message</h4>
                <textarea id="broadcastMessage" placeholder="Enter message to broadcast to all users..." rows="3"></textarea>
                <button onclick="broadcastMessage()" class="btn-broadcast">ğŸ“¤ Broadcast to All Users</button>
            </div>

            <!-- Connected Users -->
            <div>
                <h4>ğŸ‘¥ Connected Users (<span id="usersCount">0</span>)</h4>
                <div class="users-list" id="usersList">
                    <div>No users connected</div>
                </div>
                <button onclick="refreshUsers()" class="btn-refresh">ğŸ”„ Refresh Users</button>
            </div>

            <!-- Recent Chat History -->
            <div>
                <h4>ğŸ’¬ Recent Chat History</h4>
                <div class="history-list" id="chatHistory">
                    <div>No chat history</div>
                </div>
                <button onclick="refreshHistory()" class="btn-refresh">ğŸ”„ Refresh History</button>
            </div>

            <!-- Quick Actions -->
            <div>
                <h4>âš¡ Quick Actions</h4>
                <button onclick="getStats()" class="btn-refresh">ğŸ“Š Get Server Stats</button>
                <button onclick="getHistory()" class="btn-refresh">ğŸ’¬ Get Chat History</button>
                <button onclick="clearChatHistory()" class="btn-refresh">ğŸ—‘ï¸ Clear Chat History</button>
            </div>
        </div>
    </div>

    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        let socket = null;
        let adminUpdateInterval = null;

        // Debug logging
        function debugLog(message) {
            const debugConsole = document.getElementById('debugConsole');
            const timestamp = new Date().toLocaleTimeString();
            debugConsole.innerHTML += `[${timestamp}] ${message}<br>`;
            debugConsole.scrollTop = debugConsole.scrollHeight;
            console.log(`[ADMIN] ${message}`);
        }

        function clearDebugConsole() {
            document.getElementById('debugConsole').innerHTML = '<div>ğŸ”§ Debug Console - Cleared</div>';
        }

        function showSocketInfo() {
            if (socket) {
                debugLog(`ğŸ”Œ Socket ID: ${socket.id}`);
                debugLog(`ğŸ”Œ Connected: ${socket.connected}`);
            } else {
                debugLog('âŒ No socket connection');
            }
        }

        function testAdminCommands() {
            if (!socket || !socket.connected) {
                debugLog('âŒ Socket not connected');
                return;
            }
            
            debugLog('ğŸ§ª Testing admin commands...');
            
            // Test get stats
            socket.emit('get_server_stats');
            debugLog('ğŸ“Š Sent: get_server_stats');
            
            // Test get history
            socket.emit('get_chat_history');
            debugLog('ğŸ’¬ Sent: get_chat_history');
            
            // Test broadcast
            socket.emit('broadcast_message', { message: 'Test message from admin debug' });
            debugLog('ğŸ“¢ Sent: broadcast_message');
        }

        // Auto-detect environment and set server URL
        function detectEnvironment() {
            const serverUrlInput = document.getElementById('serverUrl');
            const environmentInfo = document.getElementById('environmentInfo');
            
            if (window.location.hostname.includes('render.com') || 
                (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1')) {
                // Production environment
                serverUrlInput.value = window.location.origin;
                environmentInfo.textContent = 'Production (Render)';
                environmentInfo.style.color = '#28a745';
            } else {
                // Local development
                serverUrlInput.value = 'http://localhost:10000';
                environmentInfo.textContent = 'Local Development';
                environmentInfo.style.color = '#007bff';
            }
        }

        function connectAsAdmin() {
            const serverUrl = document.getElementById('serverUrl').value;
            const adminSecret = document.getElementById('adminSecret').value;

            // Disconnect existing connection
            if (socket) {
                socket.disconnect();
                if (adminUpdateInterval) {
                    clearInterval(adminUpdateInterval);
                }
            }

            debugLog(`ğŸ”— Connecting to: ${serverUrl}`);

            // Connect with admin secret
            socket = io(serverUrl, {
                auth: {
                    secret: adminSecret
                }
            });

            // Connection events
            socket.on('connect', () => {
                debugLog('âœ… WebSocket connected');
                updateStatus('ğŸŸ¢ Connected as Admin', 'connected');
                document.getElementById('adminControls').style.display = 'block';
                
                // Request initial data
                socket.emit('get_server_stats');
                socket.emit('get_chat_history');
            });

            socket.on('disconnect', (reason) => {
                debugLog(`âŒ WebSocket disconnected: ${reason}`);
                updateStatus('ğŸ”´ Disconnected: ' + reason, 'disconnected');
                document.getElementById('adminControls').style.display = 'none';
                if (adminUpdateInterval) {
                    clearInterval(adminUpdateInterval);
                }
            });

            socket.on('connect_error', (error) => {
                debugLog(`âŒ Connection Error: ${error.message}`);
                updateStatus('ğŸ”´ Connection Error: ' + error.message, 'disconnected');
                document.getElementById('adminControls').style.display = 'none';
            });

            // Admin authentication result
            socket.on('admin_auth_result', (data) => {
                if (data.success) {
                    debugLog(`ğŸ”“ Admin authenticated: ${data.message}`);
                    updateStatus('ğŸŸ¢ Connected as Admin', 'connected');
                    document.getElementById('adminControls').style.display = 'block';
                } else {
                    debugLog(`âŒ Admin auth failed: ${data.message}`);
                    updateStatus('ğŸ”´ Authentication Failed', 'disconnected');
                    document.getElementById('adminControls').style.display = 'none';
                    alert('Admin authentication failed: ' + data.message);
                }
            });

            // Server stats update
            socket.on('server_stats_update', (stats) => {
                debugLog('ğŸ“Š Server stats received');
                updateStats(stats);
            });

            // Chat history update
            socket.on('chat_history_update', (history) => {
                debugLog(`ğŸ’¬ Chat history received: ${history.length} items`);
                updateChatHistory(history);
            });

            // Connected users update
            socket.on('connected_users_update', (users) => {
                debugLog(`ğŸ‘¥ Users update: ${users.length} users`);
                updateUsersList(users);
            });

            // Admin action results
            socket.on('admin_action_result', (result) => {
                debugLog(`âœ… ${result.action}: ${result.message} (success: ${result.success})`);
                if (result.success) {
                    alert('âœ… ' + result.message);
                } else {
                    alert('âŒ ' + result.message);
                }
            });

            // Listen for all admin events for debugging
            socket.onAny((eventName, data) => {
                if (eventName.startsWith('admin_') || eventName.includes('stats') || eventName.includes('history')) {
                    debugLog(`ğŸ“¨ Received: ${eventName}`);
                }
            });
        }

        function updateStatus(message, className) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${className}`;
        }

        function updateUsersList(users) {
            const usersList = document.getElementById('usersList');
            const usersCount = document.getElementById('usersCount');
            
            if (!users || users.length === 0) {
                usersList.innerHTML = '<div>No users connected</div>';
                usersCount.textContent = '0';
                return;
            }

            usersCount.textContent = users.length;
            usersList.innerHTML = users.map(user => `
                <div class="user-item">
                    <strong>Socket ID:</strong> ${user.socketId}<br>
                    <strong>IP:</strong> ${user.ip || 'Unknown'}<br>
                    <strong>Connected:</strong> ${user.connectionTime || 'Unknown'}<br>
                    <strong>User Agent:</strong> ${user.userAgent || 'Unknown'}<br>
                    <button onclick="kickUser('${user.socketId}')" class="btn-kick">ğŸš« Kick User</button>
                    <button onclick="blockUser('${user.socketId}')" class="btn-kick">â›” Block User</button>
                </div>
            `).join('');
        }

        function updateStats(stats) {
            const statsElement = document.getElementById('serverStats');
            if (!stats) {
                statsElement.innerHTML = '<div class="stat-item">ğŸ“Š No stats available</div>';
                return;
            }

            statsElement.innerHTML = `
                <div class="stat-item">
                    <strong>ğŸ‘¥ Connected Users</strong><br>
                    ${stats.connectedUsers || 0}
                </div>
                <div class="stat-item">
                    <strong>ğŸ’¬ Total Messages</strong><br>
                    ${stats.totalMessages || 0}
                </div>
                <div class="stat-item">
                    <strong>ğŸ“… Server Start</strong><br>
                    ${stats.serverStartTime ? new Date(stats.serverStartTime).toLocaleString() : 'Unknown'}
                </div>
                <div class="stat-item">
                    <strong>ğŸ”„ Last Update</strong><br>
                    ${stats.lastUpdate ? new Date(stats.lastUpdate).toLocaleTimeString() : 'Unknown'}
                </div>
            `;
        }

        function updateChatHistory(history) {
            const historyElement = document.getElementById('chatHistory');
            
            if (!history || history.length === 0) {
                historyElement.innerHTML = '<div>No chat history</div>';
                return;
            }

            // Show latest first
            const reversedHistory = history.slice().reverse();
            
            historyElement.innerHTML = reversedHistory.map(entry => `
                <div class="history-item">
                    <strong>[${entry.timestamp ? new Date(entry.timestamp).toLocaleString() : 'Unknown time'}]</strong><br>
                    <strong>User:</strong> ${entry.userId || entry.socketId || 'Unknown'}<br>
                    <strong>Type:</strong> ${entry.type || 'message'}<br>
                    <strong>Content:</strong> ${entry.content ? entry.content.substring(0, 100) + (entry.content.length > 100 ? '...' : '') : 'No content'}
                </div>
            `).join('');
        }

        // Admin actions
        function kickUser(socketId) {
            if (confirm(`Are you sure you want to kick user ${socketId}?`)) {
                socket.emit('kick_user', { socketId });
                debugLog(`ğŸš« Kicking user: ${socketId}`);
            }
        }

        function blockUser(socketId) {
            if (confirm(`Are you sure you want to block user ${socketId}?`)) {
                socket.emit('block_user', { socketId });
                debugLog(`â›” Blocking user: ${socketId}`);
            }
        }

        function broadcastMessage() {
            const message = document.getElementById('broadcastMessage').value.trim();
            if (!message) {
                alert('Please enter a message to broadcast');
                return;
            }
            
            if (confirm('Are you sure you want to broadcast this message to all users?')) {
                socket.emit('broadcast_message', { message });
                document.getElementById('broadcastMessage').value = '';
                debugLog(`ğŸ“¢ Broadcasting: ${message}`);
            }
        }

        function refreshUsers() {
            socket.emit('get_server_stats');
            debugLog('ğŸ”„ Refreshing users');
        }

        function getStats() {
            socket.emit('get_server_stats');
            debugLog('ğŸ“Š Getting server stats');
        }

        function getHistory() {
            socket.emit('get_chat_history');
            debugLog('ğŸ’¬ Getting chat history');
        }

        function refreshHistory() {
            socket.emit('get_chat_history');
            debugLog('ğŸ”„ Refreshing history');
        }

        function clearChatHistory() {
            if (confirm('Are you sure you want to clear ALL chat history? This cannot be undone.')) {
                socket.emit('clear_chat_history');
                debugLog('ğŸ—‘ï¸ Clearing chat history');
            }
        }

        // Initialize on load
        window.onload = function() {
            detectEnvironment();
            debugLog('ğŸš€ Admin panel loaded');
            
            // Auto-connect if secret is present
            const secret = document.getElementById('adminSecret').value;
            if (secret) {
                setTimeout(() => {
                    debugLog('ğŸ”“ Auto-connecting with saved secret...');
                    connectAsAdmin();
                }, 1000);
            }
        };

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            if (socket) {
                socket.disconnect();
            }
            if (adminUpdateInterval) {
                clearInterval(adminUpdateInterval);
            }
        });
    </script>
</body>
</html>
