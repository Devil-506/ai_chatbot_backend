<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Chatbot Admin Panel</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
        }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .users-list, .history-list, .blocked-list { 
            max-height: 300px; 
            overflow-y: auto; 
            border: 1px solid #ddd; 
            padding: 10px; 
            margin: 10px 0;
        }
        .user-item, .history-item, .blocked-item { 
            padding: 8px; 
            border-bottom: 1px solid #eee; 
        }
        .user-item:hover, .blocked-item:hover { background: #f8f9fa; }
        button { 
            padding: 8px 16px; 
            margin: 5px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
        }
        .btn-kick { background: #dc3545; color: white; }
        .btn-broadcast { background: #007bff; color: white; }
        .btn-refresh { background: #28a745; color: white; }
        .btn-unblock { background: #ffc107; color: black; }
        input, textarea { 
            width: 100%; 
            padding: 8px; 
            margin: 5px 0; 
            border: 1px solid #ddd; 
            border-radius: 4px;
        }
        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 10px; 
            margin: 10px 0;
        }
        .stat-item { 
            background: #e9ecef; 
            padding: 10px; 
            border-radius: 4px; 
            text-align: center;
        }
        .admin-section {
            border: 2px solid #28a745;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #f8fff9;
        }
        .debug-console {
            background: #1a1a1a;
            color: #00ff00;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 150px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .manual-block-section {
            background: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🏥 Medical Chatbot Admin Panel</h1>
        
        <!-- Connection Status -->
        <div id="status" class="status disconnected">
            🔴 Disconnected
        </div>

        <!-- Connection Form -->
        <div id="connectionForm">
            <h3>Connect as Admin</h3>
            <input type="text" id="serverUrl" placeholder="Server URL" value="https://ai-chatbot-backend-ouvg.onrender.com">
            <input type="password" id="adminSecret" placeholder="Admin Secret" value="iamtheserver2024">
            <button onclick="connectAsAdmin()" class="btn-refresh">🔓 Connect as Admin</button>
            
            <div style="margin-top: 10px; font-size: 12px; color: #666;">
                <strong>Auto-detected:</strong> 
                <span id="environmentInfo">Detecting environment...</span>
            </div>
        </div>

        <!-- Debug Console -->
        <div class="debug-console" id="debugConsole">
            <div>🔧 Debug Console - Ready</div>
        </div>

        <!-- Debug Controls -->
        <div style="background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 4px;">
            <h4>🔧 Debug Tools</h4>
            <button onclick="testAdminCommands()" class="btn-refresh">🧪 Test Admin Commands</button>
            <button onclick="showSocketInfo()" class="btn-refresh">🔌 Show Socket Info</button>
            <button onclick="clearDebugConsole()" class="btn-refresh">🗑️ Clear Console</button>
        </div>

        <!-- Admin Controls -->
        <div id="adminControls" style="display: none;" class="admin-section">
            <h3>🔧 Admin Controls</h3>
            
            <!-- Server Stats -->
            <div class="stats" id="serverStats">
                <div class="stat-item">📊 Loading...</div>
            </div>

            <!-- Manual Block Section -->
            <div class="manual-block-section">
                <h4>⛔ Manual Block</h4>
                <input type="text" id="manualBlockTarget" placeholder="Enter Socket ID or IP address to block">
                <input type="text" id="manualBlockReason" placeholder="Reason for blocking">
                <button onclick="manualBlock()" class="btn-kick">⛔ Block Target</button>
                
                <h4 style="margin-top: 15px;">🔓 Manual Unblock</h4>
                <input type="text" id="manualUnblockTarget" placeholder="Enter Socket ID or IP address to unblock">
                <button onclick="manualUnblock()" class="btn-unblock">🔓 Unblock Target</button>
            </div>

            <!-- Broadcast Message -->
            <div>
                <h4>📢 Broadcast Message</h4>
                <textarea id="broadcastMessage" placeholder="Enter message to broadcast to all users..." rows="3"></textarea>
                <button onclick="broadcastMessage()" class="btn-broadcast">📤 Broadcast to All Users</button>
            </div>

            <!-- Connected Users -->
            <div>
                <h4>👥 Connected Users (<span id="usersCount">0</span>)</h4>
                <div class="users-list" id="usersList">
                    <div>No users connected</div>
                </div>
                <button onclick="refreshUsers()" class="btn-refresh">🔄 Refresh Users</button>
            </div>

            <!-- Blocked List -->
            <div>
                <h4>🚫 Blocked Users & IPs (<span id="blockedCount">0</span>)</h4>
                <div class="blocked-list" id="blockedList">
                    <div>No blocked items</div>
                </div>
                <button onclick="getBlockedList()" class="btn-refresh">🔄 Refresh Blocked List</button>
                <button onclick="clearAllBlocks()" class="btn-kick">🗑️ Clear All Blocks</button>
            </div>

            <!-- Recent Chat History -->
            <div>
                <h4>💬 Recent Chat History</h4>
                <div class="history-list" id="chatHistory">
                    <div>No chat history</div>
                </div>
                <button onclick="refreshHistory()" class="btn-refresh">🔄 Refresh History</button>
            </div>

            <!-- Quick Actions -->
            <div>
                <h4>⚡ Quick Actions</h4>
                <button onclick="getStats()" class="btn-refresh">📊 Get Server Stats</button>
                <button onclick="getHistory()" class="btn-refresh">💬 Get Chat History</button>
                <button onclick="getBlockedList()" class="btn-refresh">🚫 Get Blocked List</button>
            </div>
        </div>
    </div>

    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        let socket = null;
        let adminUpdateInterval = null;
        let currentBlockedList = { ips: [], users: [] };

        // Debug logging
        function debugLog(message) {
            const debugConsole = document.getElementById('debugConsole');
            const timestamp = new Date().toLocaleTimeString();
            debugConsole.innerHTML += `[${timestamp}] ${message}<br>`;
            debugConsole.scrollTop = debugConsole.scrollHeight;
            console.log(`[ADMIN] ${message}`);
        }

        function clearDebugConsole() {
            document.getElementById('debugConsole').innerHTML = '<div>🔧 Debug Console - Cleared</div>';
        }

        function showSocketInfo() {
            if (socket) {
                debugLog(`🔌 Socket ID: ${socket.id}`);
                debugLog(`🔌 Connected: ${socket.connected}`);
            } else {
                debugLog('❌ No socket connection');
            }
        }

        function testAdminCommands() {
            if (!socket || !socket.connected) {
                debugLog('❌ Socket not connected');
                return;
            }
            
            debugLog('🧪 Testing admin commands...');
            
            // Test get stats
            socket.emit('admin_get_stats');
            debugLog('📊 Sent: admin_get_stats');
            
            // Test get history
            socket.emit('admin_get_history');
            debugLog('💬 Sent: admin_get_history');
            
            // Test broadcast
            socket.emit('admin_broadcast', { message: 'Test message from admin debug' });
            debugLog('📢 Sent: admin_broadcast');
        }

        // Auto-detect environment and set server URL
        function detectEnvironment() {
            const serverUrlInput = document.getElementById('serverUrl');
            const environmentInfo = document.getElementById('environmentInfo');
            
            if (window.location.hostname.includes('render.com') || 
                (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1')) {
                // Production environment
                serverUrlInput.value = window.location.origin;
                environmentInfo.textContent = 'Production (Render)';
                environmentInfo.style.color = '#28a745';
            } else {
                // Local development
                serverUrlInput.value = 'http://localhost:10000';
                environmentInfo.textContent = 'Local Development';
                environmentInfo.style.color = '#007bff';
            }
        }

        function connectAsAdmin() {
            const serverUrl = document.getElementById('serverUrl').value;
            const adminSecret = document.getElementById('adminSecret').value;

            // Disconnect existing connection
            if (socket) {
                socket.disconnect();
                if (adminUpdateInterval) {
                    clearInterval(adminUpdateInterval);
                }
            }

            debugLog(`🔗 Connecting to: ${serverUrl}`);

            // Connect with admin secret
            socket = io(serverUrl, {
                auth: {
                    secret: adminSecret
                }
            });

            // Connection events
            socket.on('connect', () => {
                debugLog('✅ WebSocket connected');
                updateStatus('🟢 Connected as Admin', 'connected');
                document.getElementById('adminControls').style.display = 'block';
                
                // Get initial data
                socket.emit('admin_get_stats');
                socket.emit('admin_get_blocked');
            });

            socket.on('disconnect', (reason) => {
                debugLog(`❌ WebSocket disconnected: ${reason}`);
                updateStatus('🔴 Disconnected: ' + reason, 'disconnected');
                document.getElementById('adminControls').style.display = 'none';
                if (adminUpdateInterval) {
                    clearInterval(adminUpdateInterval);
                }
            });

            socket.on('connect_error', (error) => {
                debugLog(`❌ Connection Error: ${error.message}`);
                updateStatus('🔴 Connection Error: ' + error.message, 'disconnected');
                document.getElementById('adminControls').style.display = 'none';
            });

            // Admin-specific events
            socket.on('admin_welcome', (data) => {
                debugLog(`🔓 Admin welcome: ${data.message}`);
                debugLog(`👥 Users: ${data.users.length}`);
                updateUsersList(data.users);
                updateStats(data.stats);
            });

            socket.on('admin_users_update', (data) => {
                debugLog(`👥 Users update: ${data.users.length} users`);
                updateUsersList(data.users);
                updateStats(data.stats);
            });

            socket.on('admin_stats', (stats) => {
                debugLog('📊 Server stats received');
                updateStats(stats);
            });

            socket.on('admin_chat_history', (history) => {
                debugLog(`💬 Chat history received: ${history.length} items`);
                updateChatHistory(history);
            });

            socket.on('admin_action_result', (result) => {
                debugLog(`✅ ${result.action}: ${result.message} (success: ${result.success})`);
                if (result.success) {
                    alert('✅ ' + result.message);
                    // Refresh data after successful action
                    socket.emit('admin_get_stats');
                    socket.emit('admin_get_blocked');
                } else {
                    alert('❌ ' + result.message);
                }
            });

            socket.on('admin_blocked_list', (blockedList) => {
                debugLog(`🚫 Blocked list received - IPs: ${blockedList.ips.length}, Users: ${blockedList.users.length}`);
                currentBlockedList = blockedList;
                updateBlockedList(blockedList);
            });

            // Listen for all admin events for debugging
            socket.onAny((eventName, data) => {
                if (eventName.startsWith('admin_')) {
                    debugLog(`📨 Received: ${eventName}`);
                }
            });
        }

        function updateStatus(message, className) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${className}`;
        }

        function updateUsersList(users) {
            const usersList = document.getElementById('usersList');
            const usersCount = document.getElementById('usersCount');
            
            if (!users || users.length === 0) {
                usersList.innerHTML = '<div>No users connected</div>';
                usersCount.textContent = '0';
                return;
            }

            usersCount.textContent = users.length;
            usersList.innerHTML = users.map(user => `
                <div class="user-item">
                    <strong>Socket ID:</strong> ${user.socketId}<br>
                    <strong>IP:</strong> ${user.ip || 'Unknown'}<br>
                    <strong>Connected:</strong> ${user.connectionTime || 'Unknown'}<br>
                    <strong>Status:</strong> ${user.isBlocked ? '🚫 BLOCKED' : '✅ Active'}<br>
                    <button onclick="kickUser('${user.socketId}')" class="btn-kick">🚫 Kick</button>
                    <button onclick="blockUser('${user.socketId}')" class="btn-kick">⛔ Block</button>
                    ${user.isBlocked ? `<button onclick="unblockTarget('${user.socketId}')" class="btn-unblock">🔓 Unblock</button>` : ''}
                </div>
            `).join('');
        }

        function updateStats(stats) {
            const statsElement = document.getElementById('serverStats');
            if (!stats) {
                statsElement.innerHTML = '<div class="stat-item">📊 No stats available</div>';
                return;
            }

            statsElement.innerHTML = `
                <div class="stat-item">
                    <strong>👥 Connected Users</strong><br>
                    ${stats.totalConnections || 0}
                </div>
                <div class="stat-item">
                    <strong>💬 Chat History</strong><br>
                    ${stats.chatHistorySize || 0} messages
                </div>
                <div class="stat-item">
                    <strong>🚫 Blocked IPs</strong><br>
                    ${stats.blockedIPs || 0}
                </div>
                <div class="stat-item">
                    <strong>⛔ Blocked Users</strong><br>
                    ${stats.blockedUsers || 0}
                </div>
                <div class="stat-item">
                    <strong>⏰ Server Uptime</strong><br>
                    ${stats.serverUptime ? Math.floor(stats.serverUptime / 60) + 'm ' + Math.floor(stats.serverUptime % 60) + 's' : 'Unknown'}
                </div>
            `;
        }

        function updateBlockedList(blockedList) {
            const blockedListElement = document.getElementById('blockedList');
            const blockedCount = document.getElementById('blockedCount');
            
            const totalBlocked = (blockedList.ips ? blockedList.ips.length : 0) + (blockedList.users ? blockedList.users.length : 0);
            blockedCount.textContent = totalBlocked;

            if (totalBlocked === 0) {
                blockedListElement.innerHTML = '<div>No blocked items</div>';
                return;
            }

            let html = '';
            
            if (blockedList.ips && blockedList.ips.length > 0) {
                html += '<h5>🔒 Blocked IPs:</h5>';
                html += blockedList.ips.map(ip => `
                    <div class="blocked-item">
                        <strong>IP:</strong> ${ip.ip}<br>
                        <strong>Reason:</strong> ${ip.reason || 'No reason provided'}<br>
                        <strong>Blocked At:</strong> ${ip.timestamp ? new Date(ip.timestamp).toLocaleString() : 'Unknown'}<br>
                        <strong>Blocked By:</strong> ${ip.blockedBy || 'Unknown'}<br>
                        <button onclick="unblockTarget('${ip.ip}')" class="btn-unblock">🔓 Unblock IP</button>
                    </div>
                `).join('');
            }
            
            if (blockedList.users && blockedList.users.length > 0) {
                html += '<h5>🔒 Blocked Users:</h5>';
                html += blockedList.users.map(user => `
                    <div class="blocked-item">
                        <strong>Socket ID:</strong> ${user.socketId}<br>
                        <strong>Reason:</strong> ${user.reason || 'No reason provided'}<br>
                        <strong>Blocked At:</strong> ${user.timestamp ? new Date(user.timestamp).toLocaleString() : 'Unknown'}<br>
                        <strong>Blocked By:</strong> ${user.blockedBy || 'Unknown'}<br>
                        <button onclick="unblockTarget('${user.socketId}')" class="btn-unblock">🔓 Unblock User</button>
                    </div>
                `).join('');
            }

            blockedListElement.innerHTML = html;
        }

        function updateChatHistory(history) {
            const historyElement = document.getElementById('chatHistory');
            
            if (!history || history.length === 0) {
                historyElement.innerHTML = '<div>No chat history</div>';
                return;
            }

            // Show latest first
            const reversedHistory = history.slice().reverse();
            
            historyElement.innerHTML = reversedHistory.map(entry => `
                <div class="history-item">
                    <strong>[${entry.timestampReadable || new Date(entry.timestamp).toLocaleString()}]</strong><br>
                    <strong>Socket:</strong> ${entry.socketId}<br>
                    <strong>Type:</strong> ${entry.type || 'unknown'}<br>
                    <strong>Content:</strong> ${entry.content ? entry.content.substring(0, 100) + (entry.content.length > 100 ? '...' : '') : 'No content'}
                </div>
            `).join('');
        }

        // Admin actions
        function kickUser(socketId) {
            if (confirm(`Are you sure you want to kick user ${socketId}?`)) {
                socket.emit('admin_kick_user', { socketId });
                debugLog(`🚫 Kicking user: ${socketId}`);
            }
        }

        function blockUser(socketId) {
            const reason = prompt(`Enter reason for blocking user ${socketId}:`, "Violation of terms");
            if (reason !== null) {
                socket.emit('admin_block_user', { socketId, reason });
                debugLog(`⛔ Blocking user: ${socketId} - Reason: ${reason}`);
            }
        }

        function manualBlock() {
            const target = document.getElementById('manualBlockTarget').value.trim();
            const reason = document.getElementById('manualBlockReason').value.trim() || "Manual block by admin";
            
            if (!target) {
                alert('Please enter a Socket ID or IP address to block');
                return;
            }
            
            if (confirm(`Are you sure you want to block ${target}?`)) {
                socket.emit('admin_manual_block', { socketId: target, reason });
                document.getElementById('manualBlockTarget').value = '';
                document.getElementById('manualBlockReason').value = '';
                debugLog(`⛔ Manual block: ${target} - Reason: ${reason}`);
            }
        }

        function unblockTarget(target) {
            if (confirm(`Are you sure you want to unblock ${target}?`)) {
                socket.emit('admin_unblock', { target });
                debugLog(`🔓 Unblocking: ${target}`);
            }
        }

        function manualUnblock() {
            const target = document.getElementById('manualUnblockTarget').value.trim();
            if (!target) {
                alert('Please enter a Socket ID or IP address to unblock');
                return;
            }
            
            unblockTarget(target);
            document.getElementById('manualUnblockTarget').value = '';
        }

        function clearAllBlocks() {
            if (confirm('Are you sure you want to clear ALL blocks? This will unblock all IPs and users.')) {
                // Unblock all IPs
                currentBlockedList.ips.forEach(ip => {
                    socket.emit('admin_unblock', { target: ip.ip });
                });
                
                // Unblock all users
                currentBlockedList.users.forEach(user => {
                    socket.emit('admin_unblock', { target: user.socketId });
                });
                
                debugLog('🗑️ Clearing all blocks');
                alert('Unblock commands sent for all blocked items');
            }
        }

        function broadcastMessage() {
            const message = document.getElementById('broadcastMessage').value.trim();
            if (!message) {
                alert('Please enter a message to broadcast');
                return;
            }
            
            if (confirm('Are you sure you want to broadcast this message to all users?')) {
                socket.emit('admin_broadcast', { message });
                document.getElementById('broadcastMessage').value = '';
                debugLog(`📢 Broadcasting: ${message}`);
            }
        }

        function refreshUsers() {
            socket.emit('admin_get_stats');
            debugLog('🔄 Refreshing users');
        }

        function getStats() {
            socket.emit('admin_get_stats');
            debugLog('📊 Getting server stats');
        }

        function getHistory() {
            socket.emit('admin_get_history');
            debugLog('💬 Getting chat history');
        }

        function refreshHistory() {
            socket.emit('admin_get_history');
            debugLog('🔄 Refreshing history');
        }

        function getBlockedList() {
            socket.emit('admin_get_blocked');
            debugLog('🚫 Getting blocked list');
        }

        // Initialize on load
        window.onload = function() {
            detectEnvironment();
            debugLog('🚀 Admin panel loaded');
            
            // Auto-connect if secret is present
            const secret = document.getElementById('adminSecret').value;
            if (secret) {
                setTimeout(() => {
                    debugLog('🔓 Auto-connecting with saved secret...');
                    connectAsAdmin();
                }, 1000);
            }
        };

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            if (socket) {
                socket.disconnect();
            }
            if (adminUpdateInterval) {
                clearInterval(adminUpdateInterval);
            }
        });
    </script>
</body>
</html>
